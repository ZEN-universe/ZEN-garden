name: Tests

# Define when to run
on:
  push:
    branches: bumpversion

# Env variables
env:
  CACHE_NUMBER: 0  # increase to reset cache manually

# Jobs
jobs:

  # check whether #nobump is in pull request message or commmit message: 
  # The option #nobump skips bumpversion
  check_nobump:
    runs-on: ubuntu-latest
    outputs:
      nobump: ${{ steps.check_nobump.outputs.nobump }}
    env:
      TITLE: ${{ github.event.push.head_commit.title }}
      BODY: ${{ github.event.push.head_commit.message }}
    steps:

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for '#nobump' in commit messages
        id: check_nobump
        run: |
          if [[ "$TITLE" =~ \#nobump || "$BODY" =~ \#snobump ]]; then
            nobump="true"
          else
            nobump="false"
          fi

          echo "nobump=$nobump" >> $GITHUB_ENV
          echo "npbump=$nobump" >> $GITHUB_OUTPUT
          echo "Commit Title: $TITLE"
          echo "Commit Body: $BODY"
          echo "nobump=$nobump"

  # check whether #release is in pull request message or commmit message: 
  # The option #norelease skips the release    
  check_release:
    runs-on: ubuntu-latest
    outputs:
      release: ${{ steps.check_commit.outputs.release }}
    needs: check_nobump
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for '#release' in commit messages
        id: check_commit
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            commit_message=$(git log -1 --pretty=%B)
          else
            commit_message="${{ github.event.head_commit.message }}"
          fi
      
          if [[ "$commit_message" =~ "#release" ]]; then
            release="true"
          else
            release="false"
          fi
          echo "release=$release" >> $GITHUB_ENV
          echo "release=$release" >> $GITHUB_OUTPUT
          echo "commit_message = $commit_message"
          echo "release=$release"
          
  # Bump version number
  bump_version:
    if: ${{ github.repository == 'ZEN-universe/ZEN-garden' && needs.check_skiptests.outputs.nobump == 'false' && github.event_name == 'push'}}
    runs-on: ubuntu-latest
    needs: check_release
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for tags and full history

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install bumpversion
        run: |
          python -m pip install --upgrade pip
          pip install bumpversion

      # Step to fetch the PR body and determine version bump type
      - name: Get PR body and determine bump type
        id: pr_info
        run: |
          PR_BODY=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" | jq -r '.body')
          
          echo "PR Body: $PR_BODY"
          
          # Determine bump type based on PR body
          if [[ "$PR_BODY" =~ "#major" ]]; then
            echo "bump_type=major" >> $GITHUB_ENV
          elif [[ "$PR_BODY" =~ "#minor" ]]; then
            echo "bump_type=minor" >> $GITHUB_ENV
          else
            echo "bump_type=patch" >> $GITHUB_ENV
          fi

        # For debugging
      - name: Dry run bumpversion with appropriate type
        run: |
          bumpversion ${{ env.bump_type }} --dry-run  # --dry-run shows what would change
          git diff  # Check what files are being modified

      - name: Run bumpversion with appropriate type
        run: |
          bumpversion ${{ env.bump_type }}  # Will be 'patch', 'minor', or 'major'
          git diff

      - name: Check for changes after bump
        run: |
          git log --oneline -n 2
          git show HEAD
          git branch
          git status
          git diff --name-only  # Check which files have changed
          git log -n 1  # Check the last commit, to see if a version bump commit was made

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Bump version"
          body: "Automated version bump #nobump, #release"
          #base: main
          base: bumpversion
          #branch: ${{ steps.vars.outputs.branch_name }}
          delete-branch: true  # optional: auto-delete branch after merge

      - name: Check outputs
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"

      - name: Enable auto-merge for PR
        if: ${{ steps.cpr.outputs.pull-request-number }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash  

  release:
    if: ${{ github.repository == 'ZEN-universe/ZEN-garden' && needs.check_skiptests.outputs.nobump == 'true' && needs.check_skiptests.outputs.release == 'true' && github.event_name == 'push'}}
    name: "Create Github Release"
    needs: bump_version
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get-latest-tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Extract tag version
        uses: actions-ecosystem/action-get-latest-tag@v1
        id: get-latest-tag
        with:
          semver_only: true

      - name: Check for major/minor version
        id: check_version
        run: |
          TAG=${{ steps.get-latest-tag.outputs.tag }}
          PATCH_VERSION=$(echo $TAG | cut -d. -f3)
          echo "patch=$PATCH_VERSION"
          echo "patch=$PATCH_VERSION" >> $GITHUB_ENV
          echo "tag=$TAG" >> $GITHUB_OUTPUT
  
          if [[ $PATCH_VERSION -eq 0 ]]; then
            echo "is_major_minor=true" >> $GITHUB_ENV
          else
            echo "is_major_minor=false" >> $GITHUB_ENV
          fi

      # - name: Create GitHub Release
      #   if: env.is_major_minor == 'true'
      #   uses: actions/create-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     tag_name: ${{ steps.get-latest-tag.outputs.tag }}
      #     release_name: Release ${{ steps.get-latest-tag.outputs.tag }}
      #     body: "Automated release for version ${{ steps.get-latest-tag.outputs.tag }} after major/minor version bump."
      #     draft: false
      #     prerelease: false

  build-package:
    if: ${{ github.repository == 'ZEN-universe/ZEN-garden' && github.ref == 'refs/heads/main' }}
    name: "Build and verify package"
    runs-on: ubuntu-latest
    needs: release

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.tag }}
      - uses: hynek/build-and-inspect-python-package@v2

#  release-test-pypi:
#    if: ${{ github.repository == 'ZEN-universe/ZEN-garden' && needs.check_skiptests.outputs.skiptests == 'false' }}
#    name: "Release to Test PyPI"
#    runs-on: ubuntu-latest
#    needs: build-package
#    environment:
#      name: test-pypi
#      url: https://test.pypi.org/project/zen-garden/
#    permissions:
#      id-token: write
#    steps:
#      - name: Download packages
#        uses: actions/download-artifact@v4
#        with:
#          name: Packages
#          path: dist

#      - name: Publish to Test PyPI
#        uses: pypa/gh-action-pypi-publish@release/v1
#        with:
#          repository-url: https://test.pypi.org/legacy/

  release-pypi:
    if: ${{ github.repository == 'ZEN-universe/ZEN-garden' && github.ref == 'refs/heads/main' }}
    name: "Release to PyPI"
    runs-on: ubuntu-latest
    needs: build-package
    environment:
      name: pypi
      url: https://pypi.org/project/zen-garden/
    permissions:
      id-token: write
    steps:
      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: Packages
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
